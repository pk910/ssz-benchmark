name: Daily Scheduled Benchmarks

on:
  workflow_dispatch:
  schedule:
    # Run daily at midnight UTC
    - cron: '30 2,14 * * *'

permissions:
  contents: write

jobs:
  store-results:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Get workflow timestamp
        id: timestamp
        run: echo "ts=$(date +%s)" >> "$GITHUB_OUTPUT"

      - name: Run benchmarks and store results (stable versions)
        run: ./scripts/store-results.sh --timestamp ${{ steps.timestamp.outputs.ts }}

      - name: Update to latest dev versions
        run: ./scripts/update-dev-versions.sh

      - name: Run benchmarks and store results (dev versions)
        run: ./scripts/store-results.sh --dev --timestamp ${{ steps.timestamp.outputs.ts }}

      - name: Clean up dev version changes
        run: |
          # Restore all modified files to their original state
          # This removes changes from update-dev-versions.sh before checkout
          git checkout -- .

      - name: Push results to benchmark-results branch
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # Save the generated results to a temporary location
          cp -r results /tmp/benchmark-results

          # Fetch all branches
          git fetch origin

          # Check if benchmark-results branch exists remotely
          if git ls-remote --heads origin benchmark-results | grep -q benchmark-results; then
            # Branch exists, fetch and checkout
            git checkout -B benchmark-results origin/benchmark-results
          else
            # Branch doesn't exist, create orphan branch
            git checkout --orphan benchmark-results
            git rm -rf . || true
          fi

          # Copy results back from temporary location
          rm -rf results
          cp -r /tmp/benchmark-results results

          # Add and commit
          git add results/

          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          # Rebuild the SVGs
          ./svg-gen/generate-svg-charts.js
          ./svg-gen/generate-svg-table.js

          # Add the SVGs to the commit
          git add *.svg

          # Commit the changes
          if git log --oneline -1 2>/dev/null | grep -q .; then
            # Branch has history, amend the commit
            git commit --amend -m "Update benchmark results"
          else
            # First commit on the branch
            git commit -m "Update benchmark results"
          fi

          # Force push to update the branch
          git push --force origin benchmark-results
